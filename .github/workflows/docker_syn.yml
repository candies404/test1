name: Docker é•œåƒåŒæ­¥

on:
  # schedule:
  #   - cron: '0 0 * * *'  # æ¯å¤© UTC 0:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
  workflow_dispatch:
    inputs:
      sync_mappings:
        description: 'é•œåƒåŒæ­¥æ˜ å°„ï¼ˆæ ¼å¼ï¼šæºé•œåƒ=ç›®æ ‡é•œåƒï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: false

jobs:
  image-sync:
    name: é•œåƒåŒæ­¥
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DEST_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKER_SYNC_MAPPINGS: ${{ vars.DOCKER_SYNC_MAPPINGS }}
      DOCKER_MIRRORS: ${{ vars.DOCKER_MIRRORS }}
      BUILDKIT_PROGRESS: plain

    steps:
      - name: éªŒè¯é•œåƒåŒæ­¥æ ¼å¼
        id: validate-mappings
        run: |
          # ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥
          if [ -n "${{ github.event.inputs.sync_mappings }}" ]; then
            echo "ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„åŒæ­¥æ˜ å°„"
            PROCESSED_MAPPINGS="${{ github.event.inputs.sync_mappings }}"
          else
            echo "ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„åŒæ­¥æ˜ å°„"
            PROCESSED_MAPPINGS="$DOCKER_SYNC_MAPPINGS"
          fi

          # æ¸…ç†ç‰¹æ®Šå­—ç¬¦å¹¶æ ¡éªŒæ ¼å¼
          CLEAN_MAPPINGS=$(echo "$PROCESSED_MAPPINGS" | tr -d '\r\n' | tr -s ' ' | sed -e 's/ //g' -e 's/,+/,/g' -e 's/\*//g')
          if [ -z "$CLEAN_MAPPINGS" ]; then
            echo "::error::æœªé…ç½®åŒæ­¥æ˜ å°„ï¼Œè¯·è®¾ç½®DOCKER_SYNC_MAPPINGSç¯å¢ƒå˜é‡æˆ–æ‰‹åŠ¨è¾“å…¥"
            exit 1
          fi

          # éªŒè¯è‡³å°‘åŒ…å«ä¸€ä¸ªæœ‰æ•ˆæ˜ å°„å¯¹
          if ! grep -qE '^([^=]+=[^=]+)(,[^=]+=[^=]+)*$' <<< "$CLEAN_MAPPINGS"; then
            echo "::error::æ— æ•ˆçš„æ˜ å°„æ ¼å¼ï¼Œè¯·ä½¿ç”¨'src=dst,src2=dst2'æ ¼å¼"
            exit 1
          fi

          echo "SYNC_MAPPINGS=${CLEAN_MAPPINGS}" >> $GITHUB_ENV
          
          # å¤„ç†Dockeré•œåƒæº
          if [ -n "$DOCKER_MIRRORS" ]; then
            # è½¬æ¢æ¯è¡Œä¸€ä¸ªçš„æ ¼å¼ä¸ºé€—å·åˆ†éš”ï¼Œå¹¶ç§»é™¤ç‰¹æ®Šå­—ç¬¦
            CLEAN_MIRRORS=$(echo "$DOCKER_MIRRORS" | tr '\r\n' ',' | sed -e 's/,$//' -e 's/\*//g')
            echo "DOCKER_MIRROR_LIST=${CLEAN_MIRRORS}" >> $GITHUB_ENV
            echo "å·²é…ç½®Dockeré•œåƒæº: ${CLEAN_MIRRORS}"
          else
            echo "DOCKER_MIRROR_LIST=" >> $GITHUB_ENV
            echo "æœªé…ç½®Dockeré•œåƒæºï¼Œå°†ç›´æ¥ä½¿ç”¨docker.io"
          fi

      - name: è®¾ç½®å¤šæ¶æ„æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver-opts: network=host
        env:
          DOCKER_CLI_EXPERIMENTAL: enabled  # å¯ç”¨å®éªŒç‰¹æ€§

      - name: å®‰è£… skopeo
        run: |
          echo "ğŸ› ï¸ æ­£åœ¨å®‰è£… skopeo..."
          sudo apt-get update -qq && sudo apt-get install -y skopeo
          echo "âœ… skopeo $(skopeo --version | awk '{print $3}') å®‰è£…å®Œæˆ"

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ env.DOCKERHUB_TOKEN }}
        env:
          DOCKER_REGISTRY: index.docker.io

      - name: æ‰§è¡Œé•œåƒåŒæ­¥
        id: sync
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          # é¢œè‰²å®šä¹‰
          readonly COLOR_RESET="\033[0m"
          readonly COLOR_SRC="\033[1;34m"
          readonly COLOR_DST="\033[1;35m"
          readonly COLOR_OK="\033[1;32m"
          readonly COLOR_WARN="\033[1;33m"
          readonly COLOR_ERR="\033[1;31m"

          # æ—¥å¿—å‡½æ•°
          log() {
            local level=$1
            local message=$2
            local timestamp
            timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            case $level in
                "INFO") echo -e "${COLOR_OK}[${timestamp}] INFO: ${message}${COLOR_RESET}" >&2 ;;
                "WARN") echo -e "${COLOR_WARN}[${timestamp}] WARN: ${message}${COLOR_RESET}" >&2 ;;
                "ERROR") echo -e "${COLOR_ERR}[${timestamp}] ERROR: ${message}${COLOR_RESET}" >&2 ;;
            esac
          }

          # ç»“æœæ”¶é›†å˜é‡
          success_images=""
          skipped_images=""
          failed_images=""
          
          # å¤„ç†Dockeré•œåƒæºåˆ—è¡¨
          IFS=',' read -ra DOCKER_MIRROR_ARRAY <<< "$DOCKER_MIRROR_LIST"
          # é»˜è®¤æ·»åŠ å®˜æ–¹Dockeræºä½œä¸ºæœ€åçš„å¤‡é€‰é¡¹
          DOCKER_MIRROR_ARRAY+=("docker.io")
          log "INFO" "é…ç½®çš„Dockeré•œåƒæº: ${DOCKER_MIRROR_ARRAY[*]}"

          # è§£æç¯å¢ƒå˜é‡åˆ°å…³è”æ•°ç»„
          declare -A SYNC_MAP=()
          IFS=',' read -ra MAPPING_PAIRS <<< "$SYNC_MAPPINGS"
          for pair in "${MAPPING_PAIRS[@]}"; do
            key="${pair%%=*}"
            value="${pair#*=}"
            # æ¸…ç†æ‰å¯èƒ½çš„ç‰¹æ®Šå­—ç¬¦
            key=$(echo "$key" | tr -d '\r\n\t*')
            value=$(echo "$value" | tr -d '\r\n\t*')
            if [[ -z "$key" || -z "$value" ]]; then
              log "ERROR" "æ— æ•ˆçš„æ˜ å°„å¯¹: $pair"
              exit 1
            fi
            log "INFO" "æ·»åŠ æ˜ å°„: $key -> $value"
            SYNC_MAP["$key"]="$value"
          done

          normalize_image() {
            local image_ref=$1 default_tag=$2 context=$3 registry=$4
            local image_name image_tag

            # æ¸…ç†è¾“å…¥ä¸­å¯èƒ½çš„ç‰¹æ®Šå­—ç¬¦
            image_ref=$(echo "$image_ref" | tr -d '\r\n\t*')

            if [[ "$image_ref" == *":"* ]]; then
              image_name="${image_ref%:*}"
              image_tag="${image_ref#*:}"
            else
              image_name="$image_ref"
              image_tag="$default_tag"
            fi

            case $context in
              "source")
                if [[ "$image_name" == *"/"* ]]; then
                  printf "%s/%s:%s" "$registry" "$image_name" "$image_tag"
                else
                  printf "%s/library/%s:%s" "$registry" "$image_name" "$image_tag"
                fi
                ;;
              "target")
                if [[ "$image_name" == *"/"* ]]; then
                  printf "docker.io/%s:%s" "$image_name" "$image_tag"
                else
                  printf "docker.io/%s/%s:%s" "$DEST_REPO" "$image_name" "$image_tag"
                fi
                ;;
              *)
                log "ERROR" "æ— æ•ˆä¸Šä¸‹æ–‡å‚æ•°: $context"
                exit 1
                ;;
            esac
          }

          get_architecture() {
            local image=$1
            log "INFO" "è·å–æ¶æ„ä¿¡æ¯ï¼š${COLOR_SRC}$image${COLOR_RESET}"
            # ä»…æ£€æŸ¥æ˜¯å¦å­˜åœ¨ manifests æ•°ç»„
            if raw_manifest=$(skopeo inspect --raw --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://$image" 2>&1) &&
                jq -e '.manifests != null' <<< "$raw_manifest" &>/dev/null; then
                local arch_list
                arch_list=$(jq -r '
                [.manifests[].platform |
                    select(.os != "unknown" and .architecture != "unknown") |
                    "\(.os)/\(.architecture)\(if .variant != "" then "/"+.variant else "" end)" |
                    sub("/$"; "")  # å…³é”®ä¿®æ­£ç‚¹
                ] | unique | join(",")' <<< "$raw_manifest")
                [[ -z "$arch_list" ]] && { log "ERROR" "æ— æœ‰æ•ˆæ¶æ„ä¿¡æ¯"; return 1; }
                log "INFO" "ğŸ“¦ æ£€æµ‹åˆ°å¤šæ¶æ„é•œåƒï¼š$arch_list"
                echo "$arch_list"
                return 0
            else
              local inspect_info os arch variant
              inspect_info=$(skopeo inspect --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://$image" 2>/dev/null)
              os=$(jq -r '.Os // "unknown"' <<< "$inspect_info")
              arch=$(jq -r '.Architecture // "unknown"' <<< "$inspect_info")
              variant=$(jq -r '.Variant? // ""' <<< "$inspect_info")

              [[ "$os" == "unknown" || "$arch" == "unknown" ]] && {
                log "INFO" "ğŸ§¬ å•æ¶æ„ä¿¡æ¯ï¼šunknown"
                echo "unknown"
                return 0
              }

              local result="${os}/${arch}"
              [[ -n "$variant" ]] && result+="/$variant"
              case "$arch" in
                "arm64")
                  result="linux/arm64/v8"
                  ;;
                "arm")
                  [[ "$variant" == "v7" ]] && result="linux/arm/v7"
                  ;;
              esac
              log "INFO" "ğŸ§¬ å•æ¶æ„ä¿¡æ¯ï¼š$result"
              echo "$result"
            fi
          }

          sync_image() {
            local src=$1 dst=$2
            log "INFO" "å¯åŠ¨åŒæ­¥ï¼š${COLOR_SRC}$src â†’ ${COLOR_DST}$dst"
            log "INFO" "æ‰§è¡Œå‘½ä»¤: skopeo copy --all --src-creds \${DOCKERHUB_USER}:\${DOCKERHUB_TOKEN} --dest-creds \${DOCKERHUB_USER}:\${DOCKERHUB_TOKEN} docker://$src docker://$dst"
            skopeo copy --all --src-creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" \
                        --dest-creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" \
                        "docker://$src" "docker://$dst" || {
                local exit_code=$?
                log "ERROR" "åŒæ­¥å¤±è´¥ï¼Œé€€å‡ºç : $exit_code"
                return 1
            }
            log "INFO" "åŒæ­¥å®Œæˆ"
          }

          try_with_mirrors() {
            local source_ref=$1
            local function_name=$2
            local success=false
            local result=""
            local original_image=""
            
            # ä½¿ç”¨å¾ªç¯å°è¯•æ¯ä¸ªé•œåƒæº
            for mirror in "${DOCKER_MIRROR_ARRAY[@]}"; do
              log "INFO" "å°è¯•ä½¿ç”¨é•œåƒæº: $mirror"
              local src_image=$(normalize_image "$source_ref" "latest" "source" "$mirror")
              
              # ä¿å­˜åŸå§‹é•œåƒå¼•ç”¨ï¼ˆç¬¬ä¸€æ¬¡è¿­ä»£æ—¶ï¼‰
              if [[ -z "$original_image" ]]; then
                original_image="$src_image"
              fi
              
              if [[ "$function_name" == "get_architecture" ]]; then
                if arch=$(get_architecture "$src_image" 2>/dev/null); then
                  result="$arch"
                  success=true
                  log "INFO" "æˆåŠŸä» $mirror è·å–æ¶æ„ä¿¡æ¯"
                  break
                else
                  log "WARN" "ä» $mirror è·å–æ¶æ„ä¿¡æ¯å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªé•œåƒæº"
                fi
              elif [[ "$function_name" == "get_digest" ]]; then
                if digest=$(skopeo inspect --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" --format '{{.Digest}}' "docker://$src_image" 2>/dev/null); then
                    if [[ -n "$digest" ]]; then
                    result="$digest"
                    success=true
                    log "INFO" "æˆåŠŸä» $mirror è·å–é•œåƒæ‘˜è¦: $digest"
                    break
                    else
                    log "WARN" "ä» $mirror è·å–åˆ°ç©ºæ‘˜è¦ï¼Œå°è¯•ä¸‹ä¸€ä¸ªé•œåƒæº"
                    fi
                else
                    log "WARN" "ä» $mirror è·å–é•œåƒæ‘˜è¦å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªé•œåƒæº"
                fi
              elif [[ "$function_name" == "sync" ]]; then
                local dst_image="$2"
                if sync_image "$src_image" "$dst_image"; then
                  success=true
                  log "INFO" "ä½¿ç”¨ $mirror é•œåƒæºåŒæ­¥æˆåŠŸ"
                  break
                else
                  log "WARN" "ä½¿ç”¨ $mirror é•œåƒæºåŒæ­¥å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªé•œåƒæº"
                fi
              fi
            done
            
            if ! $success; then
              log "ERROR" "æ‰€æœ‰é•œåƒæºéƒ½å¤±è´¥: $original_image"
              return 1
            fi
            
            echo "$result"
            return 0
          }

          # å¤„ç†åŒæ­¥å¾ªç¯
          for source_ref in "${!SYNC_MAP[@]}"; do
            echo "::group::ğŸ”„ Processing $source_ref"
            dst_ref="${SYNC_MAP[$source_ref]}"
            dst_image=$(normalize_image "$dst_ref" "latest" "target" "docker.io")

            echo -e "${COLOR_OK}æ¶æ„å¯¹æ¯”æŠ¥å‘Šï¼š${COLOR_RESET}"

            # ä½¿ç”¨é•œåƒæºå°è¯•è·å–æºé•œåƒæ¶æ„
            src_arch=$(try_with_mirrors "$source_ref" "get_architecture")
            if [[ $? -ne 0 ]]; then
              log "ERROR" "æ— æ³•è·å–æºé•œåƒæ¶æ„ä¿¡æ¯"
              failed_images+="âŒ \`${source_ref}\` â†’ \`${dst_ref}\` (æ— æ³•è·å–æºé•œåƒæ¶æ„)\n"
              echo "::endgroup::"
              continue
            fi

            # æ£€æŸ¥ç›®æ ‡é•œåƒæ˜¯å¦å­˜åœ¨
            if target_info=$(skopeo inspect --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://$dst_image" 2>/dev/null); then
              dst_arch=$(get_architecture "$dst_image" 2>/dev/null || echo "N/A")
              dst_exists=true
              dst_digest=$(jq -r '.Digest' <<< "$target_info")
            else
              dst_arch="N/A"
              dst_exists=false
              dst_digest="N/A"
            fi

            # ä½¿ç”¨é•œåƒæºå°è¯•è·å–æºé•œåƒæ‘˜è¦
            src_digest=$(try_with_mirrors "$source_ref" "get_digest")
            if [[ $? -ne 0 ]]; then
              log "ERROR" "æ— æ³•è·å–æºé•œåƒæ‘˜è¦"
              failed_images+="âŒ \`${source_ref}\` â†’ \`${dst_ref}\` (æ— æ³•è·å–æºé•œåƒæ‘˜è¦)\n"
              echo "::endgroup::"
              continue
            fi

            # æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥
            if $dst_exists && [[ "$dst_digest" == "$src_digest" ]]; then
              log "INFO" "æºDigest: ${COLOR_SRC}$src_digest${COLOR_RESET}"
              log "INFO" "ç›®æ ‡Digest: ${COLOR_DST}$dst_digest${COLOR_RESET}"
              log "INFO" "ç›®æ ‡é•œåƒå·²æ˜¯æœ€æ–°ï¼Œè·³è¿‡åŒæ­¥"
              skipped_images+="ğŸ”œ ${source_ref} â†’ ${dst_ref}\n"
              echo "::endgroup::"
              continue
            fi

            # æ‰§è¡ŒåŒæ­¥
            if try_with_mirrors "$source_ref" "sync" "$dst_image"; then
              success_images+="âœ… \`${source_ref}\` â†’ \`${dst_ref}\`\n"
            else
              failed_images+="âŒ \`${source_ref}\` â†’ \`${dst_ref}\`\n"
            fi

            echo "::endgroup::"
          done

          # ç”Ÿæˆé€šçŸ¥å†…å®¹
          notification_content=""

          if [[ -n "$success_images" ]]; then
            notification_content+="ğŸ‰ **åŒæ­¥æˆåŠŸ**ï¼š\n${success_images}\n"
            echo "HAS_SUCCESS=true" >> $GITHUB_ENV
          else
            notification_content+="ğŸ‰ **åŒæ­¥æˆåŠŸ**ï¼šæ— \n\n"
            echo "HAS_SUCCESS=false" >> $GITHUB_ENV
          fi

          if [[ -n "$skipped_images" ]]; then
            notification_content+="â© **è·³è¿‡åŒæ­¥**ï¼š\n${skipped_images}\n"
          else
            notification_content+="ğŸ”œ **è·³è¿‡åŒæ­¥**ï¼šæ— \n\n"
          fi

          if [[ -n "$failed_images" ]]; then
            notification_content+="ğŸ’¥ **å¤±è´¥ä»»åŠ¡**ï¼š\n${failed_images}"
          else
            notification_content+="âœ… **å¤±è´¥ä»»åŠ¡**ï¼šæ— "
          fi

          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "NOTIFICATION_CONTENT<<EOF" >> $GITHUB_ENV
          echo -e "$notification_content" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # è®¾ç½®ç»“æœæ ‡è®°
          if [[ -n "$success_images" ]]; then
            echo "HAS_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "HAS_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: å‘é€é€šçŸ¥
        uses: candies404/Multi-Channel-Notifier@latest
        if: ${{ env.HAS_SUCCESS == 'true' }}
        with:
          title: "é•œåƒåŒæ­¥ç»“æœ"
          content: |
            ${{ env.NOTIFICATION_CONTENT }}
          hitokoto: 'false'
          wpush_key: ${{ secrets.WPUSH_KEY }}
