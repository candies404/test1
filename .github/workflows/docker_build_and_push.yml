name: "Docker镜像构建与推送"  

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: '目标仓库名称（如：myorg/myrepo）'
        required: true
        type: string
      dockerfile_path:
        description: 'Dockerfile路径（默认：./Dockerfile）'
        required: false
        type: string
        default: 'Dockerfile'
      dockerfile_content:
        description: '自定义Dockerfile内容（可选）'
        required: false
        type: string
      image_tag:
        description: '镜像标签（如：v1.0, 默认：latest）' 
        required: false
        type: string
        default: 'latest'

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 配置Dockerfile
        run: |
          echo "🔄 处理Dockerfile..."
          if [ -n "${{ inputs.dockerfile_content }}" ]; then
            echo "${{ inputs.dockerfile_content }}" > ${{ inputs.dockerfile_path }}
            echo "✅ 已生成自定义Dockerfile"
          else
            echo "ℹ️ 使用现有的：${{ inputs.dockerfile_path }}"
          fi

      - name: 登录Docker Hub
        run: |
          echo "🔑 登录Docker Hub..."
          echo "${{ env.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ env.DOCKERHUB_USERNAME }}" \
            --password-stdin
          echo "✅ 登录成功！"

      - name: 构建并推送镜像
        run: |
          IMAGE_NAME="${{ inputs.target_repo }}:${{ inputs.image_tag }}"
          echo "🏗️ 构建镜像：$IMAGE_NAME"
          docker build -t "$IMAGE_NAME" -f "${{ inputs.dockerfile_path }}" .
          echo "🚀 推送镜像到Docker Hub..."
          docker push "$IMAGE_NAME"
          echo "✅ 镜像已推送：$IMAGE_NAME"
