name: "Dockeré•œåƒæ„å»ºä¸æ¨é€"  

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åç§°ï¼ˆå¦‚ï¼šmyorg/myrepoï¼‰'
        required: true
        type: string
      dockerfile_path:
        description: 'Dockerfileè·¯å¾„ï¼ˆé»˜è®¤ï¼š./Dockerfileï¼‰'
        required: false
        type: string
        default: 'Dockerfile'
      dockerfile_content:
        description: 'è‡ªå®šä¹‰Dockerfileå†…å®¹ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      image_tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆå¦‚ï¼šv1.0, é»˜è®¤ï¼šlatestï¼‰' 
        required: false
        type: string
        default: 'latest'

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½®Dockerfile
        run: |
          echo "ğŸ”„ å¤„ç†Dockerfile..."
          if [ -n "${{ inputs.dockerfile_content }}" ]; then
            echo "${{ inputs.dockerfile_content }}" > ${{ inputs.dockerfile_path }}
            echo "âœ… å·²ç”Ÿæˆè‡ªå®šä¹‰Dockerfile"
          else
            echo "â„¹ï¸ ä½¿ç”¨ç°æœ‰çš„ï¼š${{ inputs.dockerfile_path }}"
          fi

      - name: ç™»å½•Docker Hub
        run: |
          echo "ğŸ”‘ ç™»å½•Docker Hub..."
          echo "${{ env.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ env.DOCKERHUB_USERNAME }}" \
            --password-stdin
          echo "âœ… ç™»å½•æˆåŠŸï¼"

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        run: |
          IMAGE_NAME="${{ inputs.target_repo }}:${{ inputs.image_tag }}"
          echo "ğŸ—ï¸ æ„å»ºé•œåƒï¼š$IMAGE_NAME"
          docker build -t "$IMAGE_NAME" -f "${{ inputs.dockerfile_path }}" .
          echo "ğŸš€ æ¨é€é•œåƒåˆ°Docker Hub..."
          docker push "$IMAGE_NAME"
          echo "âœ… é•œåƒå·²æ¨é€ï¼š$IMAGE_NAME"
